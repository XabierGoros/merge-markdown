---
title: My Course Title
author: Chuck Grant
creator: Adobe Digital Learning Services
subject: Instructor Led Training
---

<img class="cover-page" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOMAAADeCAMAAAD4tEcNAAAAkFBMVEX6DwD////6AAD/8fD9qKX9urj+5+b+3979t7X+4eD//Pz7RkH8jYr7VlL8f3z/9vX7T0r9wb/6GxD8npz+0c/8k5D6Lif+5uX9srD7Yl77SkX9rKr7Qjz+zMv8mZb+2dj8dXL7XFj6Ihn6MSr7bWn7NzH+xsT7VE/8eHX7Z2T7OzX+1NL8hoP6GA37YFz8kI2wOZPiAAAHuUlEQVR4nO2d6VbbMBCF5WEJSSAkGAJNaSiEpUAp7/92tbNgI8v2tWJLMzq+f3tI9YEjje8sUlG1RoNZPLkfzy8UP13Mx/eTeDYY1TCoqn+8i89oI984Jdqu7iwe2DEOlw984b4rWefDctiY8XkqBXCjZLXTX40Yj55EAW5E9DSDGYcLgYSpiMbXGOOnUMJURJ8A4/VKLmEqWh3XMd4I/iNuRHRTzTiRTpiKJlWMP0JATCB/lDKOFmEgJpCLUQnjOBTEBPJtZGT8Fw5iAjk1Mf4OCTGB/F1k/BkWYgIZ64zD0BATyIHGOA+Qcf6d8TQ8xATyNM94HCJiAnmcYzwLlPEsY3wOEzGBfP5ivA2W8XbHeBkqYgJ5uWUM9NuYav2NVMFuqhulW2vCGAfNGK8ZAwxxMqXBjooGISOuo1YV9qO6flhVyLtqqmRnVaOwERNFKvCvY/qFVLPgGWcq8C0n3XRUEM54lWiiAt9W041VvfleQ+d6U3PfS+hcc8WxKKVdhU/Yq1evXuGJquV7eS2I6PGwSo/yKWkZ1WkpHJKOahGj6EQ0JP0BEKPoj2RIKtSuGXUtmHGb/6vXvVzITfoP0C+xjPQAIkbRg1TIrEKmVodiGc9hxnOhjLlqrnoJPT6osrFEk8w6Lxo3QIwikbWzUBiXSWROghohRpHv9VqIrhoyCnz9AEPVTAfiGOm1IWIUPUqDpLImtnK9C2P8qo9toidZkHRowXgjjBEPVXMSxah3PIESVfFN5c3BVZJUndgwVM0kKHFP5r7gegnyPD4sEQXVYALeeJnEeB50YM0opXqPHq0RxTQLr2vxbSWjRJHe9kCMoqkEyELrejOJ8Dyaehy6BDDS3z0ZBXgeZJoK0kT8PQ84HVcu9p4HnI4r1x13xsr5WKCYex4N0nHlYl4DsUeomol30NooHVcu1p4H3bXCyNnz2DNUzcR4PAqdtMTI2PPYN1TNxNbz2M2OqBaUQWfreUDpuAm093I9PugfsPhzws5Qpp4HlI5LHkIoFuLpeWDpuLRoDLJfWXoeUDpufShANjpLzwNKx62LOPMzw8rFsE0KKjneBmlQBRZDzwNa9zbYhn4f/DwPLB23Wzb0XLPzPKDKsa+EP3R88PM8gEVn85awCmVm45mgyrHcHwY6Pph5HlB8lpsoiR0frBi1oa5mfaunhqoiPjlBQum4bxMloOoWTp4HrYAFa/0N0PHxygcSClW1QX14eMtDVHe7RCr9ReIC+Bk+nofddwvKjLCZfAvtkX8LjEiGi4vnAZ11hsVCvxomngcUsxgeOugRZ9IaCbmqps3DaqvyIqhyzDga1ObI8SMoVDW+C+Iul2dBlWMl7/SQW8lgqBgUqpZ4M9Dx4b81EgtVy5YJZQ+8D/mHKsdKvVKoYMm757Hn/g/9uOc7N6A/REXugn4CP+/Z8wDTceU/Dx0fXhnpBVhhZVwNHR9XPiGh96PKnDCUtPRpmWM2afV7LvS0e/Q8ILu7xq+Aigg8TsKHfKe6Whvr1xYngqoXav1DKIrw5nlAlWO1PjA9AZ/iy/PYXBxRJ+BzkKi+YAe5EVQ5BsQoUCLBk2UObRZIfg06Pl58QEKbPvTOAH2SF88D+u1jY3GgJ8KD50H3wLrA7RA6Pjx4HliTQ8lAS/2zkNpe954HOHPs4Migk0K9OHR8OB8HtV+Tg34SQOaec8/DbpDDl/ToBzJpHY+D2rfJQX8jhOpCjhwzNpk5ZpJuKELHh1NGLFStku5jQYGhU8+j4cwxkzQ/Ejo+nHoeLTQ56PYA9KLm0PNoPHPMJK0DEDo+HI6DaqU7Tp96BH2os9ZIi5ljJumMSK7W2Tgoi5ljJukJO+RL7srzsJo5ZpAeZEObtSPPw2rmmElaHgQq13bkeUD5NESFyBw5PpyMwLacOQasFwqCnXgee4eqmfTjDnqZceB50KI1xIJrB72UOvA8rGeOmaS/LSH1ng48D/uZYybZ/AI79zz2mDlmUmxxfHTuebQSqmYqxAHIhtZxnQeUm2girZAO6jbruM6j5UfVzrzquI8XvFgFl/7cIQ9K12FA43HV1SpabUBVU9ceJNHNQWs6Np3n9HZ0XPVDlw5s1poruZrJ6j/oHLFXr169evXq1atXr169morhSKWWdaHmvpfQuebq1vcSuhbdKkFXn9iJzhSTBvzuRBPFoN23W1GsWM7ja1M0UzyHR7YoGiiJd0s2U6Qk36ONiO4TxsA3HYoTxsC/kDRIGPnMU+pCaVGYYjEQozulpSKK1xS31pXmEtNZlAGHrOupJymjx47mrrVuAFrPFGU2BLQ9bfoXlIsEuzdtGt82s2ED/UZuZxBtGAPdWrcFGtsZv6xvd7HVrgd4N8d4FR7kV937jnEYIONQY5R2kXa9shFL2cxt562w3SpX9ZabK874MqLmyk9oys9O9zz/q03R08jMOAoGksb5HpTvM/AD8Xa0+QzanH/vcwfbkN4Lo99l8FN8WSEV5vIV7mu4Fm7v0KpwIazhTopTwX9KMs2pMd27MZwKpSSammZlm+8Wmc0FUhLNzW0+ZfenzBbCKIkWZY1M5XfEDK8+pNRuJ+v8WJZPdK+8B+d9+cK7TH27upflexVG3V0/o8EsnrxOVxxLXC5W09dJPBvU9Q7/B9QKXtcNvVQOAAAAAElFTkSuQmCC"></img>
<div class="cover-page cover-text">
  <div class="type"> Activity Guide </div>
  <div class="title"> My Course Title </div>
  <div class="creator"> Adobe Digital Learning Services </div>
</div>

<div class="page-break"></div>




<div class="copyright"> 
©2022 Adobe. All rights reserved. 
</br></br>
My Course Title
</br></br>
If this guide is distributed with software that includes an end user agreement, this guide, as well as the software described in it, is furnished under license and may be used or copied only in accordance with the terms of such license. Except as permitted by any such license, no part of this guide may be reproduced, stored in a retrieval system, or transmitted, in any form or by any means, electronic, mechanical, recording, or otherwise, without the prior written permission of Adobe. Please note that the content in this guide is protected under copyright law even if it is not distributed with software that includes an end user license agreement.
</br></br>
The content of this guide is furnished for informational use only, is subject to change without notice, and should not be construed as a commitment by Adobe. Adobe assumes no responsibility or liability for any errors or inaccuracies that may appear in the informational content contained in this guide.
</br></br>
Please remember that existing artwork or images that you may want to include in your project may be protected under copyright law. The unauthorized incorporation of such material into your new work could be a violation of the rights of the copyright owner. Please be sure to obtain any permission required from the copyright owner.
</br></br>
Any references to company names in sample templates are for demonstration purposes only and are not intended to refer to any actual organization.
</br></br>
Adobe, the Adobe logo, Acrobat, the Creative Cloud logo, and the Adobe Marketing Cloud logo are either registered trademarks or trademarks of Adobe in the United States and/or other countries.
</br></br>
All other trademarks are the property of their respective owners.
</br></br>
Adobe, 345 Park Avenue, San Jose, California 95110, USA.
</br></br>
Notice to U.S. Government End Users. The Software and Documentation are “Commercial Items,” as that term is defined at 48 C.F.R. §2.101, consisting of “Commercial Computer Software” and “Commercial Computer Software Documentation,” as such terms are used in 48 C.F.R. §12.212 or 48 C.F.R. §227.7202, as applicable. Consistent with 48 C.F.R. §12.212 or 48 C.F.R. §§227.7202-1 through 227.7202-4, as applicable, the Commercial Computer Software and Commercial Computer Software Documentation are being licensed to U.S. Government end users (a) only as Commercial Items and (b) with only those rights as are granted to all other end users pursuant to the terms and conditions herein. Unpublished-rights reserved under the copyright laws of the United States. Adobe agrees to comply with all applicable equal opportunity laws including, if appropriate, the provisions of Executive Order 11246, as amended, Section 402 of the Vietnam Era Veterans Readjustment Assistance Act of 1974 (38 USC 4212), and Section 503 of the Rehabilitation Act of 1973, as amended, and the regulations at 41 CFR Parts 60-1 through 60-60, 60-250, and 60-741. The affirmative action clause and regulations contained in the preceding sentence shall be incorporated by reference.
</br></br></br></br>
<div class="last-updated">10/22/2022</div>
</div>
<div class="page-break"></div>

<div class="toc" >
  <div>Course Contents</div>
  <!-- START auto-update -->
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

- [Module 1: First Module Title (H1)](#module-1-first-module-title-h1)
    - [List Examples (H3)](#list-examples-h3)
    - [Table, Quote, and Hyperlink Examples (H3)](#table-quote-and-hyperlink-examples-h3)
    - [Code block and Code Snippet examples (H3)](#code-block-and-code-snippet-examples-h3)
  - [Exercise 1: Example Exercise (H2)](#exercise-1-example-exercise-h2)
  - [Workflow Purge Task (H2)](#workflow-purge-task-h2)
  - [Exercise 2: Configure a Purge Task (H2)](#exercise-2-configure-a-purge-task-h2)
  - [Exercise 3: Create a Monthy Window (H2)](#exercise-3-create-a-monthy-window-h2)
- [Module 2: Second Module Title](#module-2-second-module-title)
    - [Tasks](#tasks)
    - [Configure](#configure)
    - [Windows](#windows)
  - [Exercise 1: Update AEM](#exercise-1-update-aem)
  - [Workflow Purge Task](#workflow-purge-task)
  - [Exercise 2: My Configuration Task](#exercise-2-my-configuration-task)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->
  <!-- END auto-update -->
</div>
<div class="page-break"></div>

# Module 1: First Module Title (H1)

This is the introduction to this module. After the introduction, there is a module table of contents that provides quick links to all topics and exercises in this module. If the student came to this module on accident, there is a secondary link "..back to the course table of contents" that lets the student go back to the global TOC.

#### Objectives (H4)

- Lorem Ipsum
  - Lorem Ipsum
- Lorem Ipsum

<!-- START auto-update -->
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
#### Module Contents

- [Module 1: First Module Title (H1)](#module-1-first-module-title-h1)
    - [List Examples (H3)](#list-examples-h3)
    - [Table, Quote, and Hyperlink Examples (H3)](#table-quote-and-hyperlink-examples-h3)
    - [Code block and Code Snippet examples (H3)](#code-block-and-code-snippet-examples-h3)
  - [Exercise 1: Example Exercise (H2)](#exercise-1-example-exercise-h2)
  - [Workflow Purge Task (H2)](#workflow-purge-task-h2)
  - [Exercise 2: Configure a Purge Task (H2)](#exercise-2-configure-a-purge-task-h2)
  - [Exercise 3: Create a Monthy Window (H2)](#exercise-3-create-a-monthy-window-h2)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->
[Return to Course Contents](#course-contents)
<!-- END auto-update -->
<div class="page-break"></div>

### List Examples (H3)

My First List

* Unordered 1
  * Unordered 2
    * Unordered 3
        * Unordered 4
* Unordered 5

My Second List

- Unordered 1
  - Unordered 2
- Unordered 3

My Third List

1. Ordered 1
   1. Ordered 2
      1. Ordered 3
      2. Ordered 4
   2. Ordered 5
2. Ordered 6

### Table, Quote, and Hyperlink Examples (H3)

[Link Example][mod1-csconfigs] are processes that run on a schedule in order to optimize the repository. With AEM as a Cloud Service, the need for customers to configure the operational properties of maintenance tasks is minimal. Customers can focus their resources on application-level concerns, leaving the infrastructure operations to Adobe. [Link Example 2][mod1-audit]

| Task                         | Owner    | How to configure (optional)                                  |
| :--------------------------- | :------- | :----------------------------------------------------------- |
| Datastore garbage collection | Adobe    | N/A - fully Adobe owned                                      |
| Version Purge                | Adobe    | Window owned by Adobe and OSGi configuration owned by customer |
| Audit Log Purge              | Adobe    | Window owned by Adobe and OSGi configuration owned by customer |
| Ad-hoc Task Purge            | Customer | Maintenance Window and OSGi Configuration                    |
| Workflow Purge               | Customer | Maintenance Window and OSGi Configuration                    |
| Project Purge                | Customer | Maintenance Window and OSGi Configuration                    |

> **NOTE** This is a very nice note.

### Code block and Code Snippet examples (H3)

OSGi confgurations allow for a maintenance task to be configured specific to the business requirements for purging content.
Code block:
`/apps/example/components  `

Code Snippet
```xml
<?xml version="1.0" encoding="UTF-8"?>
<jcr:root xmlns:sling="http://sling.apache.org/jcr/sling/1.0" 
  xmlns:jcr="http://www.jcp.org/jcr/1.0" 
  jcr:primaryType="sling:Folder"
  sling:configCollectionInherit="true"
  sling:configPropertyInherit="true"
  windowSchedule="daily"
  windowStartTime="03:00"
  windowEndTime="05:00"
 />
```

#### Example H4
The Maintenance UI can be used to easily configure the windows on a local AEM instance and them syncronzied back into the AEM project to be checked into source control. Alternatively, you can add and edit the xml files directly.

##### Example H5

The Maintenance UI can be used to easily configure the windows on a local AEM instance and them syncronzied back into the AEM project to be checked into source control. Alternatively, you can add and edit the xml files directly.

## Exercise 1: Example Exercise (H2)

**Scenario**: Your company has started using AEM projects to help support new products being added to your website. To maintain the performance in AEM, you need to purge the unused projects that users might have abandoned or are no longer needed. Because projects are used so often, purging needs to be performed daily.

Prerequisites:

- AEM running

1. Go to Tools > Operations > Maintenance
1. Click on the **Daily Maintenance Window** card.
2. Image with Return, tab, and < img > with zoom 15%
    <img src="m1/links/Backpack_C.jpg" alt="Backpack_C" style="zoom: 15%;" />
3. Image with NO Return and < img > <img src="m1/links/Backpack_C.jpg" alt="Backpack_C" />
4. Image with Return, tab, and ! [] ()
    ![Backpack_C](m1/links/Backpack_C.jpg)
5. Image with NO Return and ! [] () ![Backpack_C](m1/links/Backpack_C.jpg)
6. Image with Return only and < img >
<img src="m1/links/Backpack_C.jpg" alt="Backpack_C" />
1. Image with 2 Returns and < img >

    <img src="m1/links/Backpack_C.jpg" alt="Backpack_C" />

2. From the dropdown, select **Project Purge** and click **Save**
3. The bottom of the Project Purge card specifies when it will run next. For testing purposes, you can manually start the task immeditately. 
4. Hover over the card and click the **play** button. Notice how the purge task fails. This is because it has not been configured yet.

> **Congratulations!** You have successfully created a daily purge task within a maintenance window.

## Workflow Purge Task (H2)

Minimizing the number of workflow instances increases the performance of the workflow engine, so you can regularly purge completed or running workflow instances from the repository.

Configure **Adobe Granite Workflow Purge Configuration** to purge workflow instances according their age and status. You can also purge workflow instances of all models or of a specific model .

<img src="m1/links/Backpack_C.jpg" alt="Backpack_C" style="zoom: 15%;" />

You can also create multiple configurations of the service to purge workflow instances that satisfy different criteria. For example, create a configuration that purges the instances of a particular workflow model when they are running for much longer than the expected time. Create another configuration that purges all completed workflows after a certain number of days to minimize the size of the repository.

## Exercise 2: Configure a Purge Task (H2)

**Scenario:** In AEM, runtime workflow models are stored in `/var/workflows/models/`. In this exercise you will configure a workflow purge task for the Adobe provide Publish Example workflow to purge completed workflows that are older than 30 days.

**Prerequisites:**

- AEM running
- Eclipse with a Maven Project imported

#### Task 1: Create OSGi Config (H4)

1. In AEM, navigate to **Tools > Operations > Web Console**
2. In the configuration console find the **Adobe Granite Workflow Purge Configuration** factory
> **Hint** Use the browser find feature (crtl+f) to quickly find the configuration

> **Note** a factory configuration means you can have multiple instances of the configuration

3. Click on the the configuration factory and observe the different options of the configuration:

|          Option Name          |          Description           |
| :---------------------------: | :----------------------------: |
|      scheduledpurge.name      | Name that shows up in the logs |
| scheduledpurge.workflowStatus |       COMPLETED/RUNNING        |
|    scheduledpurge.modelIds    |    List of models to purge     |
|    scheduledpurge.daysold     |     Age of models to purge     |

> **Note** The Factory Persistance Identity (PID) will also be needed to create the json config file.

4. Keep this browser window open to observe the configuration file against these configurations.

5. Open your project in Eclipse.
6. Since configurations are considered immutable content, navigate to **devops.ui.apps > src/main/content/jcr_root > apps > training**

7. Right click on **config.author** and select **New > File**
    <img src="m1/links/Backpack_C.jpg" alt="Backpack_C" style="zoom: 15%;" />

8. Enter **com.adobe.granite.workflow.purge.Scheduler~training.cfg.json** as the file name and click **Finish.**

9. The file will open in the editor. In the **Exercise Files**, navigate to **training-files/Maintenanc**e and copy the contents of **com.adobe.granite.workflow.purge.Scheduler~training.cfg.json**

   > **Note** This purge task has **daysold** set to 0 to show the purge task successfully running in the next task.

10. Verify the file contents verify against the configuration in the web console in the browser. **Save** your changes in the Eclipse editor.

#### Task 2: Install and verify the purge configuration (H4)

1. In the Project Explorer, right-click **devops-training** and select **Run As > Maven Build**. The build starts.
2. Verify that the build completed successfully
3. In AEM, navigate to **Tools > Operations > Web Console**
4. In the configuration console find the **Adobe Granite Workflow Purge Configuration** factory. There should now be an instance of the factory called **com.adobe.granite.workflow.purge.Scheduler~training**. Open it.
5. Notice the configurations you added to the JSON file are now properly configured.
6. To observe the purge task successfully running, you will need to complete a Publish Example workflow. Navigate to the **Sites Console**
7. Select **WKND Site > Create > Workflow**
   1. Workflow model = Publish Example
   2. Workflow Title = Publish WKND
   3. Select **Next**
   4. Select **Create**
8. The workflow has successfully started. To complete the workflow, Go to the **Inbox** in the top right corner (bell icon) and click **View all**.
9. Select the work item, **Validate Content** and click **Complete**.
10. Click **Ok** in the popup to complete the work item. The page publishes and the workflow is complete.
11. Verify the Completed workflow by going to **Tools > Workflow > Archive**. Observe the completed workflow.
12. You can manually kick off maintenance tasks outside the normal maintenance window for testing purposes. Navigate to **Tools > Operations > Maintenance**
13. Click on **Weekly Maintenance Window**. On the **Workflow Purge** card, click the **play** button.
14. You will see the card go from yellow to green when the task is complete. To verify the purge successfully occurred, navigate back to  **Tools > Workflow > Archive** and notice the archived Publish Example workflow instance no longer exists.

> **Congratulations!** You have successfully configured a purge task and tested it successfully.

## Exercise 3: Create a Monthy Window (H2)
**Scenario:** Your company has started using ad-hoc tasks and you want to make sure older tasks are properly removed from the system. This is not a widely used feature and purging old tasks is not top priority. You want to create a monthly maintenance window to purge any tasks out of compliance with the out of the box ad-hoc task purge configuration. This configuration purges completed tasks older than 30 days and active tasks older than 90 days. See ` com.adobe.granite.taskmanagement.impl.purge.TaskPurgeMaintenanceTask` in the web console.

Prerequisites:

- AEM running


1. In AEM, Navigate to **Tools > General > CRXDE Lite**
2. In the JCR tree on the left, navigate to **/libs/settings/granite/operations/maintenance**
3. Copy the **granite_weekly** node and paste it under **/conf/global/settings/granite/operations/maintenance**
4. Save.
5. Under **/conf/global/settings/granite/operations/maintenance** delete the 3 nodes under **granite_weekly** and **Save**.
6. Rename **granite_weekly** to **granite_monthly** and **Save**
7. Select **granite_monthly** and in the properties pane on the bottom right, update the **windowSchedule** to **monthy** and **Save**.
8. At this point we can use the Maintenance UI to complete the window. In AEM, navigate to **Tools > Operations > Maintenance**
9. Hover over **Monthly Maintenance Window** and click the **Configure gears.**
10. Change the start and end days to **Friday** and **Save**
11. Click on the **Monthly Maintenance Window** to open it.
12. Click the **Add** icon. 
13. Select **Purge of ad-hoc tasks** and **Save**.

> **Congratulations**! You have successfully added the ad-hoc purge task to a monthly maintenance window.

[mod1-csconfigs]: https://docs.adobe.com/content/help/en/experience-manager-cloud-service/operations/maintenance.html
[mod1-audit]: https://docs.adobe.com/content/help/en/experience-manager-65/administering/operations/operations-audit-log.html


# Module 2: Second Module Title

This is the introduction to this module. After the introduction, there is a module table of contents that provides quick links to all topics and exercises in this module. If the student came to this module on accident, there is a secondary link "..back to the course table of contents" that lets the student go back to the global TOC.

#### Objectives

- Lorem Ipsum
- Lorem Ipsum

<!-- START auto-update -->
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
#### Module Contents

- [Module 2: Second Module Title](#module-2-second-module-title)
    - [Tasks](#tasks)
    - [Configure](#configure)
    - [Windows](#windows)
  - [Exercise 1: Update AEM](#exercise-1-update-aem)
  - [Workflow Purge Task](#workflow-purge-task)
  - [Exercise 2: My Configuration Task](#exercise-2-my-configuration-task)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->
[Return to Course Contents](#course-contents)
<!-- END auto-update -->



### Tasks

[Another Task][mod2-ipsum] are processes that run on a schedule in order to optimize the repository. With AEM as a Cloud Service, the need for customers to configure the operational properties of maintenance tasks is minimal. Customers can focus their resources on [application-level concerns][mod2-lorem], leaving the infrastructure operations to Adobe.

| Task                         | Owner    | How to configure (optional)                                  |
| :--------------------------- | :------- | :----------------------------------------------------------- |
| Datastore garbage collection | Adobe    | N/A - fully Adobe owned                                      |
| Version Purge                | Adobe    | Window owned by Adobe and OSGi configuration owned by customer |
| Audit Log Purge              | Adobe    | Window owned by Adobe and OSGi configuration owned by customer |
| Ad-hoc Task Purge            | Customer | Maintenance Window and OSGi Configuration                    |
| Workflow Purge               | Customer | Maintenance Window and OSGi Configuration                    |
| Project Purge                | Customer | Maintenance Window and OSGi Configuration                    |

### Configure

OSGi confgurations allow for a maintenance task to be configured specific to the business requirements for purging content.

- Version Purge Configuration
- Audit Log Configuration

### Windows

Workflow Purge, Ad-hoc Task Purge and Project Purge Maintenance tasks to be executed during the daily, weekly, or monthly maintenance windows. These configurations should be added directly in source control.

#### Daily Configuration Example
```xml
<?xml version="1.0" encoding="UTF-8"?>
<jcr:root xmlns:sling="http://sling.apache.org/jcr/sling/1.0" 
  xmlns:jcr="http://www.jcp.org/jcr/1.0" 
  jcr:primaryType="sling:Folder"
  sling:configCollectionInherit="true"
  sling:configPropertyInherit="true"
  windowSchedule="daily"
  windowStartTime="03:00"
  windowEndTime="05:00"
 />
```

The Maintenance UI can be used to easily configure the windows on a local AEM instance and them syncronzied back into the AEM project to be checked into source control. Alternatively, you can add and edit the xml files directly.

## Exercise 1: Update AEM

**Scenario**: Your company has started using AEM projects to help support new products being added to your website. To maintain the performance in AEM, you need to purge the unused projects that users might have abandoned or are no longer needed. Because projects are used so often, purging needs to be performed daily.

Prerequisites:

- AEM running

1. Go to Tools > Operations > Maintenance
1. Click on the **Daily Maintenance Window** card.
2. Select the **+ Add** button
    <img src="m2/links/Backpack_C.jpg" alt="Backpack_C" style="zoom: 15%;" />
3. From the dropdown, select **Project Purge** and click **Save**
4. The bottom of the Project Purge card specifies when it will run next. For testing purposes, you can manually start the task immeditately. 
5. Hover over the card and click the **play** button. Notice how the purge task fails. This is because it has not been configured yet.

**Congratulations!** You have successfully created a daily purge task within a maintenance window.

## Workflow Purge Task

Minimizing the number of workflow instances increases the performance of the workflow engine, so you can regularly purge completed or running workflow instances from the repository.

Configure **Adobe Granite Workflow Purge Configuration** to purge workflow instances according their age and status. You can also purge workflow instances of all models or of a specific model .

<img src="m2/links/Backpack_C.jpg" alt="Backpack_C" style="zoom: 15%;" />

You can also create multiple configurations of the service to purge workflow instances that satisfy different criteria. For example, create a configuration that purges the instances of a particular workflow model when they are running for much longer than the expected time. Create another configuration that purges all completed workflows after a certain number of days to minimize the size of the repository.

## Exercise 2: My Configuration Task

**Scenario:** In AEM, runtime workflow models are stored in `/var/workflows/models/`. In this exercise you will configure a workflow purge task for the Adobe provide Publish Example workflow to purge completed workflows that are older than 30 days.

**Prerequisites:**

- AEM running
- Eclipse with a Maven Project imported

#### Task 1: Create OSGi Config

1. In AEM, navigate to **Tools > Operations > Web Console**
2. In the configuration console find the **Adobe Granite Workflow Purge Configuration** factory
> **Hint**: Use the browser find feature (crtl+f) to quickly find the configuration

> **Note**: a factory configuration means you can have multiple instances of the configuration

3. Click on the the configuration factory and observe the different options of the configuration:

|          Option Name          |          Description           |
| :---------------------------: | :----------------------------: |
|      scheduledpurge.name      | Name that shows up in the logs |
| scheduledpurge.workflowStatus |       COMPLETED/RUNNING        |
|    scheduledpurge.modelIds    |    List of models to purge     |
|    scheduledpurge.daysold     |     Age of models to purge     |

> **Note**: The Factory Persistance Identity (PID) will also be needed to create the json config file.

4. Keep this browser window open to observe the configuration file against these configurations.

5. Open your project in Eclipse.
6. Since configurations are considered immutable content, navigate to **devops.ui.apps > src/main/content/jcr_root > apps > training**

7. Right click on **config.author** and select **New > File**
    <img src="m2/links/Backpack_C.jpg" alt="Backpack_C" style="zoom: 15%;" />

8. Enter **com.adobe.granite.workflow.purge.Scheduler~training.cfg.json** as the file name and click **Finish.**

9. The file will open in the editor. In the **Exercise Files**, navigate to **training-files/Maintenanc**e and copy the contents of **com.adobe.granite.workflow.purge.Scheduler~training.cfg.json**

   > **Note**: This purge task has **daysold** set to 0 to show the purge task successfully running in the next task.

10. Verify the file contents verify against the configuration in the web console in the browser. **Save** your changes in the Eclipse editor.

#### Task 2: Install and verify the purge configuration

1. In the Project Explorer, right-click **devops-training** and select **Run As > Maven Build**. The build starts.
2. Verify that the build completed successfully
3. In AEM, navigate to **Tools > Operations > Web Console**
4. In the configuration console find the **Adobe Granite Workflow Purge Configuration** factory. There should now be an instance of the factory called **com.adobe.granite.workflow.purge.Scheduler~training**. Open it.
5. Notice the configurations you added to the JSON file are now properly configured.
6. To observe the purge task successfully running, you will need to complete a Publish Example workflow. Navigate to the **Sites Console**
7. Select **WKND Site > Create > Workflow**
   1. Workflow model = Publish Example
   2. Workflow Title = Publish WKND
   3. Select **Next**
   4. Select **Create**
8. The workflow has successfully started. To complete the workflow, Go to the **Inbox** in the top right corner (bell icon) and click **View all**.
9. Select the work item, **Validate Content** and click **Complete**.
10. Click **Ok** in the popup to complete the work item. The page publishes and the workflow is complete.
11. Verify the Completed workflow by going to **Tools > Workflow > Archive**. Observe the completed workflow.
12. You can manually kick off maintenance tasks outside the normal maintenance window for testing purposes. Navigate to **Tools > Operations > Maintenance**
13. Click on **Weekly Maintenance Window**. On the **Workflow Purge** card, click the **play** button.
14. You will see the card go from yellow to green when the task is complete. To verify the purge successfully occurred, navigate back to  **Tools > Workflow > Archive** and notice the archived Publish Example workflow instance no longer exists.

**Congratulations!** You have successfully configured a purge task and tested it successfully.

[mod2-lorem]:  www.something.com
[mod2-ipsum]:  www.something.com

